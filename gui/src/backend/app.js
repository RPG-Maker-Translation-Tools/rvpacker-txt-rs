const{app:app,BrowserWindow:BrowserWindow,Menu:Menu,ipcMain:ipcMain,shell:shell,screen:screen,dialog:dialog}=require("electron"),{readFileSync:readFileSync,writeFileSync:writeFileSync}=require("fs"),{join:join}=require("path"),DEBUG=!0,firstLaunch=JSON.parse(readFileSync(join(__dirname,"launch.json"),"utf8")).firstLaunch;let forceClose;firstLaunch||writeFileSync(join(__dirname,"launch.json"),JSON.stringify({firstLaunch:!0},null,4)),app.on("ready",(()=>{const e=()=>{const{width:e,height:o}=screen.getPrimaryDisplay().workAreaSize,i=new BrowserWindow({width:e,height:o,titleBarStyle:"hiddenInset",webPreferences:{preload:join(__dirname,"../frontend/main.js"),nodeIntegration:!0},show:!1});i.webContents.openDevTools();const t=[{label:"Файл",submenu:[{label:"Перегрузить",accelerator:"F5"},{label:"Закрыть",accelerator:"Alt+F4"}]},{label:"Редактирование",submenu:[{label:"Отменить",role:"undo"},{label:"Повторить",role:"redo"},{type:"separator"},{label:"Вырезать",role:"cut"},{label:"Копировать",role:"copy"},{label:"Вставить",role:"paste"}]},{label:"Помощь",submenu:[{label:"Как пользоваться программой?",click:()=>{const e=new BrowserWindow({width:640,height:480,autoHideMenuBar:!0});e.setAlwaysOnTop(!0),e.loadFile(join(__dirname,"../frontend/help.html"))}},{label:"Горячие клавиши",click:()=>{const e=new BrowserWindow({width:640,height:480,autoHideMenuBar:!0});e.setAlwaysOnTop(!0,"pop-up-menu"),e.loadFile(join(__dirname,"../frontend/hotkeys.html"))}}]},{label:"О программе",click:()=>{const e=new BrowserWindow({width:640,height:480,autoHideMenuBar:!0,webPreferences:{preload:join(__dirname,"../frontend/about.js"),nodeIntegration:!0}});e.setAlwaysOnTop(!0),e.loadFile(join(__dirname,"../frontend/about.html"))}}];i.setMenu(Menu.buildFromTemplate(t)),i.loadFile(join(__dirname,"../frontend/main.html")),i.once("ready-to-show",(()=>{i.show(),i.maximize(),i.focus(),firstLaunch&&n()})),i.on("close",(e=>{forceClose?app.quit():(e.preventDefault(),i.webContents.send("exit-sequence",!0),console.log("close"))}))},n=()=>{const e=new BrowserWindow({width:800,height:600,autoHideMenuBar:!0});e.setAlwaysOnTop(!0),e.loadFile(join(__dirname,"../frontend/help.html"))};e(),app.on("window-all-closed",(()=>{"darwin"!==process.platform&&app.quit()})),ipcMain.on("quit",(()=>{forceClose=!0,app.quit()})),ipcMain.handle("quit-confirm",(()=>dialog.showMessageBox({type:"warning",title:"У вас остались несохранённые изменения",message:"Вы уверены, что хотите выйти?",buttons:["Сохранить и выйти","Выйти без сохранения","Отмена"],defaultId:2,cancelId:2}).then((({response:e})=>0===e||1===e&&(forceClose=!0,void app.quit()))))),ipcMain.on("openLink",((e,n)=>{shell.openExternal(n)})),ipcMain.handleOnce("create-settings-file",(()=>dialog.showMessageBox({type:"question",title:"Создать файл настроек?",message:"Файл с настройками программы не был найден. Создать его?",detail:"Отказ приведёт к закрытию программы.",buttons:["Создать","Отмена"],defaultId:0,cancelId:1}).then((({response:e})=>0===e?(writeFileSync(join(__dirname,"../frontend/settings.json"),JSON.stringify({backup:{enabled:!0,period:60,max:99}},null,4),"utf8"),dialog.showMessageBoxSync({type:"info",message:"Был создан стандартный файл настроек программы с опциями: - резервное копирование включено\n- интервал резервного копирования 60 секунд\n- максимальное количество резервных копий 99.",buttons:["ОК"]}),!0):(app.quit(),!1))))),app.on("activate",(()=>{0===BrowserWindow.getAllWindows().length&&e()}))}));